// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Enums
// =============================================================================

enum Institution {
  UNI
  HOCHSCHULE
  BOTH
}

enum EventType {
  VORTRAG
  LABORFUEHRUNG
  RUNDGANG
  WORKSHOP
  LINK
  INFOSTAND
}

enum LocationType {
  INFOMARKT_SCHLOSS
  INFOMARKT_CN
  OTHER
}

enum UserRole {
  ADMIN
  ORGANIZER
  PUBLIC
}

// =============================================================================
// Core Tables
// =============================================================================

/// Study program cluster for grouping related programs
model StudyProgramCluster {
  id          String         @id @default(cuid())
  name        String         @db.VarChar(200)
  description String?        @db.Text
  programs    StudyProgram[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("study_program_clusters")
}

/// Study program offered by Uni or Hochschule
model StudyProgram {
  id          String                @id @default(cuid())
  name        String                @db.VarChar(200)
  institution Institution
  clusterId   String?
  cluster     StudyProgramCluster?  @relation(fields: [clusterId], references: [id], onDelete: SetNull)
  events      EventStudyProgram[]
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([institution])
  @@index([clusterId])
  @@map("study_programs")
}

/// Physical location (building/room) for events
model Location {
  id           String   @id @default(cuid())
  buildingName String   @db.VarChar(200)
  roomNumber   String?  @db.VarChar(50)
  address      String?  @db.Text
  latitude     Float?
  longitude    Float?
  events       Event[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([buildingName])
  @@map("locations")
}

/// Information market (Infomarkt) locations
model InformationMarket {
  id       String                    @id @default(cuid())
  name     String                    @db.VarChar(200)
  location String                    @db.VarChar(200)
  events   EventInformationMarket[]

  @@map("information_markets")
}

// =============================================================================
// Event Tables
// =============================================================================

/// Main event entity - lectures, workshops, tours, info stands, etc.
model Event {
  id              String                    @id @default(cuid())
  title           String                    @db.VarChar(200)
  description     String?                   @db.Text
  eventType       EventType
  timeStart       DateTime?
  timeEnd         DateTime?
  locationType    LocationType
  locationDetails Json?                     @db.JsonB
  roomRequest     String?                   @db.Text
  meetingPoint    String?                   @db.VarChar(500)
  additionalInfo  String?                   @db.Text
  photoUrl        String?                   @db.VarChar(500)
  institution     Institution
  locationId      String?
  location        Location?                 @relation(fields: [locationId], references: [id], onDelete: SetNull)
  lecturers       Lecturer[]
  organizers      EventOrganizer[]
  studyPrograms   EventStudyProgram[]
  infoMarkets     EventInformationMarket[]
  scheduleItems   ScheduleItem[]
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([eventType])
  @@index([institution])
  @@index([timeStart])
  @@index([locationId])
  @@map("events")
}

/// Lecturer/speaker for an event
model Lecturer {
  id         String  @id @default(cuid())
  eventId    String
  event      Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  firstName  String  @db.VarChar(100)
  lastName   String  @db.VarChar(100)
  title      String? @db.VarChar(50)
  email      String? @db.VarChar(200)
  building   String? @db.VarChar(100)
  roomNumber String? @db.VarChar(50)

  @@index([eventId])
  @@map("lecturers")
}

/// Event organizer contact information (internal use)
model EventOrganizer {
  id           String  @id @default(cuid())
  eventId      String
  event        Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  email        String  @db.VarChar(200)
  phone        String? @db.VarChar(50)
  internalOnly Boolean @default(true)

  @@index([eventId])
  @@map("event_organizers")
}

/// Junction table: Event to StudyProgram (many-to-many)
model EventStudyProgram {
  eventId        String
  studyProgramId String
  event          Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  studyProgram   StudyProgram @relation(fields: [studyProgramId], references: [id], onDelete: Cascade)

  @@id([eventId, studyProgramId])
  @@index([studyProgramId])
  @@map("event_study_programs")
}

/// Junction table: Event to InformationMarket (many-to-many)
model EventInformationMarket {
  eventId  String
  marketId String
  event    Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  market   InformationMarket @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@id([eventId, marketId])
  @@index([marketId])
  @@map("event_information_markets")
}

// =============================================================================
// User & Schedule Tables
// =============================================================================

/// User account for authentication and authorization
model User {
  id            String         @id @default(cuid())
  email         String         @unique @db.VarChar(200)
  passwordHash  String?        @db.VarChar(255)
  name          String?        @db.VarChar(200)
  role          UserRole       @default(PUBLIC)
  schedules     UserSchedule[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([email])
  @@index([role])
  @@map("users")
}

/// User's personal schedule/cart of events
model UserSchedule {
  id        String         @id @default(cuid())
  userId    String?
  user      User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?        @db.VarChar(100) // For anonymous users
  name      String         @default("My Schedule") @db.VarChar(100)
  items     ScheduleItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@map("user_schedules")
}

/// Individual item in a user's schedule
model ScheduleItem {
  id         String       @id @default(cuid())
  scheduleId String
  schedule   UserSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  eventId    String
  event      Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  priority   Int          @default(1)
  notes      String?      @db.Text
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@unique([scheduleId, eventId])
  @@index([eventId])
  @@map("schedule_items")
}
